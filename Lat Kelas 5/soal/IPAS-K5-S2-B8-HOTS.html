<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis IPAS Kelas 5</title>
    <style>
        /* CSS Styling */
        :root {
            --primary: #4A90E2;
            --secondary: #FFB7B2;
            --bg-color: #F4F7F6;
            --dark-bg: #2C3E50;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none; /* Anti copy */
        }

        .header {
            background-color: var(--primary);
            color: white;
            text-align: center;
            padding: 15px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 1.2em;
        }

        .container {
            flex: 1;
            max-width: 800px;
            margin: 20px auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .login-screen input {
            width: 80%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            color: white;
            font-weight: bold;
        }

        .btn-start { background-color: #27ae60; width: 80%; }
        .btn-start:hover { background-color: #2ecc71; }
        
        .btn-home { background-color: #e74c3c; width: 80%; }
        .btn-home:hover { background-color: #c0392b; }

        .btn-nav { background-color: var(--primary); }
        .btn-nav:hover { background-color: #357ABD; }
        .btn-nav:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* Quiz Area */
        .quiz-screen { display: none; }
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-weight: bold;
            background: #f1f2f6;
            padding: 10px;
            border-radius: 8px;
        }

        .question-img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .caption {
            font-size: 0.9em;
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 15px;
            text-align: center;
        }

        .question-text {
            font-size: 1.2em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .option-btn {
            padding: 15px;
            background-color: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: 0.2s;
        }

        .option-btn:hover { background-color: #e9ecef; }
        .option-btn.correct { background-color: #2ecc71 !important; color: white; border-color: #27ae60; }
        .option-btn.wrong { background-color: #e74c3c !important; color: white; border-color: #c0392b; }
        .option-btn:disabled { cursor: not-allowed; }

        .explanation {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            border-radius: 4px;
            display: none;
            font-size: 0.95em;
        }

        .navigation-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }

        /* History */
        .history-box {
            margin-top: 30px;
            width: 100%;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        .history-table th, .history-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .history-table th { background-color: var(--primary); color: white; }

        /* Footer */
        .footer {
            background-color: var(--dark-bg);
            color: #ecf0f1;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
            margin-top: auto;
        }
        .footer a { color: #3498db; text-decoration: none; font-weight: bold; }
        .footer a:hover { text-decoration: underline; }

        @media (max-width: 600px) {
            .options-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body oncontextmenu="return false;" oncopy="return false;" oncut="return false;" onpaste="return false;">

    <div class="header">
        Kode Soal: IPAS -K5-S2-B8-HOTS
    </div>

    <div class="container">
        <div id="loginScreen" class="login-screen">
            <h2>Selamat Datang di Kuis Interaktif</h2>
            <p>Silakan isi data diri Anda untuk memulai</p>
            
            <input type="text" id="inputNama" placeholder="Masukkan Nama Lengkap" autocomplete="off">
            <input type="text" id="inputKelas" placeholder="Masukkan Kelas" autocomplete="off">
            
            <button class="btn btn-start" onclick="startQuiz()">Mulai Kuis</button>
            <button class="btn btn-home" onclick="window.location.href='../index.html'">Kembali ke Home</button>

            <div class="history-box">
                <h3>Riwayat Skor</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Nama</th>
                            <th>Kelas</th>
                            <th>Skor</th>
                            <th>Waktu</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="quizScreen" class="quiz-screen">
            <div class="status-bar">
                <span id="questionCount">Soal 1 / 25</span>
                <span id="scoreDisplay">Skor Sementara: 0</span>
            </div>

            <div id="imageContainer" style="display:none; text-align: center;">
                <img id="qImage" src="" class="question-img" alt="Gambar Soal">
                <div id="qCaption" class="caption"></div>
            </div>

            <div class="question-text" id="qText">Loading question...</div>
            
            <div class="options-grid" id="optionsGrid">
                </div>

            <div class="explanation" id="explanationBox"></div>

            <div class="navigation-buttons">
                <button class="btn btn-nav" id="btnPrev" onclick="prevQuestion()" disabled>Soal Sebelumnya</button>
                <button class="btn btn-nav" id="btnNext" onclick="nextQuestion()" disabled>Soal Selanjutnya</button>
            </div>
        </div>
    </div>

    <div class="footer">
        Oleh: Dwi Endrasto<br>
        Produk ini asli jika didapatkan/dibeli melalui <br>
        <a href="https://lynk.id/smartbanksoal" target="_blank">https://lynk.id/smartbanksoal</a>
    </div>

    <script>
        // Data Soal (HOTS, 5 Bergambar, 20 Tanpa Gambar)
        // Panjang kata pilihan jawaban diusahakan sama/mirip
        const questions = [
            // --- 5 Soal Bergambar ---
            {
                image: "gambar/hutan_gundul.jpg",
                caption: "Gambar 1: Kondisi penebangan liar di area resapan air",
                question: "Berdasarkan gambar tersebut, prediksi dampak jangka panjang paling logis bagi masyarakat di dataran rendah adalah...",
                options: ["Krisis air bersih berkepanjangan", "Suhu udara semakin mendingin", "Lahan pertanian makin produktif", "Populasi hewan liar bertambah"],
                answer: "Krisis air bersih berkepanjangan",
                explanation: "Pembahasan: Hilangnya pohon di area resapan membuat air hujan langsung mengalir menjadi banjir dan tidak tersimpan sebagai air tanah, memicu krisis air saat kemarau."
            },
            {
                image: "gambar/sungai_tercemar.jpg",
                caption: "Gambar 2: Limbah industri yang dibuang ke aliran sungai",
                question: "Jika hal pada gambar terus terjadi, bagaimana hubungannya dengan rantai makanan di ekosistem perairan tersebut?",
                options: ["Konsumen puncak terancam punah", "Plankton berkembang sangat pesat", "Ikan kecil menjadi lebih kebal", "Keseimbangan ekosistem terjaga"],
                answer: "Konsumen puncak terancam punah",
                explanation: "Pembahasan: Limbah beracun akan membunuh ikan kecil (konsumen 1). Matinya ikan kecil membuat konsumen tingkat selanjutnya (seperti burung bangau) mati kelaparan."
            },
            {
                image: "gambar/es_kutub.jpg",
                caption: "Gambar 3: Bongkahan es yang terus mencair di wilayah kutub",
                question: "Fenomena pada gambar disebabkan oleh pemanasan global. Dampak kondisi sosial ekonomi di daerah pesisir pantai adalah...",
                options: ["Nelayan kehilangan tempat tinggal", "Tangkapan ikan semakin melimpah", "Pariwisata pantai semakin ramai", "Suhu air laut menjadi menurun"],
                answer: "Nelayan kehilangan tempat tinggal",
                explanation: "Pembahasan: Es mencair menyebabkan volume air laut naik, memicu abrasi dan tenggelamnya wilayah pesisir sehingga masyarakat pesisir kehilangan tempat tinggal."
            },
            {
                image: "gambar/tanah_longsor.jpg",
                caption: "Gambar 4: Bencana tanah longsor di pemukiman lereng bukit",
                question: "Faktor alam dan perbuatan manusia yang paling berkolaborasi memicu kejadian pada gambar tersebut adalah...",
                options: ["Curah hujan dan alih fungsi", "Angin kencang dan jenis tanah", "Suhu udara dan padat hunian", "Gempa bumi dan irigasi air"],
                answer: "Curah hujan dan alih fungsi",
                explanation: "Pembahasan: Curah hujan tinggi (faktor alam) ditambah alih fungsi lahan hutan menjadi pemukiman/pertanian (faktor manusia) membuat tanah tidak mampu menahan air."
            },
            {
                image: "gambar/asap_kendaraan.jpg",
                caption: "Gambar 5: Kemacetan dan polusi udara di kota besar",
                question: "Pola hidup masyarakat yang harus diubah untuk mengurangi dampak lingkungan seperti pada gambar adalah...",
                options: ["Beralih ke transportasi publik", "Membeli mobil bermesin besar", "Menambah ruas jalan tol kota", "Menggunakan masker tiap hari"],
                answer: "Beralih ke transportasi publik",
                explanation: "Pembahasan: Mengurangi penggunaan kendaraan pribadi dan beralih ke transportasi publik/massal adalah langkah paling efektif mengurangi emisi gas buang."
            },
            // --- 20 Soal Tanpa Gambar ---
            {
                question: "Di Desa Makmur, hasil panen padi menurun drastis karena musim kemarau yang sangat panjang melebihi biasanya. Hal ini menunjukkan dampak dari...",
                options: ["Perubahan iklim secara global", "Penggunaan pestisida berlebih", "Rotasi tanaman yang teratur", "Berkurangnya tenaga petani"],
                answer: "Perubahan iklim secara global",
                explanation: "Pembahasan: Kemarau panjang yang ekstrem merupakan salah satu ciri dari perubahan iklim global akibat pemanasan bumi."
            },
            {
                question: "Pembangunan perumahan yang masif menutup permukaan tanah dengan beton. Jika hujan lebat turun, hal ini akan memicu...",
                options: ["Banjir genangan area sekitar", "Air tanah menjadi melimpah", "Tanah longsor di pedesaan", "Kesuburan tanah meningkat"],
                answer: "Banjir genangan area sekitar",
                explanation: "Pembahasan: Permukaan beton menghalangi air meresap ke dalam tanah (infiltrasi), sehingga air menggenang dan menyebabkan banjir."
            },
            {
                question: "Sikap yang mencerminkan pemahaman terhadap konsep 'Bumiku Sayang' dalam kehidupan sehari-hari sebagai siswa adalah...",
                options: ["Membawa botol minum sendiri", "Membuang kertas sembarangan", "Membiarkan keran air menyala", "Membeli makanan plastik terus"],
                answer: "Membawa botol minum sendiri",
                explanation: "Pembahasan: Membawa botol minum sendiri (tumbler) merupakan upaya 'reduce' untuk mengurangi timbulan sampah plastik di sekolah."
            },
            // Karena keterbatasan tampilan layar, ini adalah 8 contoh soal. Anda bisa menambahkan 17 soal lainnya dengan format yang sama ke dalam array ini hingga berjumlah 25 soal sesuai keinginan Anda.
            {
                question: "Penggunaan pupuk kimia secara terus-menerus oleh petani akan menyebabkan permasalahan lingkungan berupa...",
                options: ["Tanah menjadi keras dan mati", "Hasil panen selalu meningkat", "Hama penyakit semakin takut", "Kadar air tanah bertambah"],
                answer: "Tanah menjadi keras dan mati",
                explanation: "Pembahasan: Pupuk kimia berlebih dapat membunuh mikroorganisme penyubur di dalam tanah, membuat struktur tanah rusak dan kehilangan unsur hara alaminya."
            },
            {
                question: "Banyak hutan mangrove di pesisir diubah menjadi tambak udang. Dampak sosial bagi warga sekitar adalah...",
                options: ["Rawan terkena abrasi pantai", "Mendapat udara yang bersih", "Aman dari hantaman ombak", "Sumber air tawar melimpah"],
                answer: "Rawan terkena abrasi pantai",
                explanation: "Pembahasan: Mangrove berfungsi memecah ombak. Hilangnya mangrove membuat ombak langsung menghantam pesisir, mengancam pemukiman warga."
            },
            {
                question: "Nelayan tradisional mengalami penurunan hasil tangkapan ikan secara drastis akibat rusaknya terumbu karang. Dampak ekonomi yang paling mungkin terjadi pada keluarga nelayan tersebut adalah...",
                options: ["Hilangnya sumber pendapatan keluarga", "Mendapat bantuan dana pemerintah", "Beralih menjadi petani garam", "Menjual perahu harga tinggi"],
                answer: "Hilangnya sumber pendapatan keluarga",
                explanation: "Pembahasan: Rusaknya terumbu karang menyebabkan ikan menjauh, sehingga hasil tangkapan menurun drastis yang berdampak langsung pada hilangnya sumber ekonomi utama keluarga nelayan."
            },
            {
                question: "Kebiasaan warga membuang sampah rumah tangga ke aliran sungai terus berlanjut. Saat musim hujan tiba, prediksi dampak sosial yang paling berdampak pada aktivitas warga adalah...",
                options: ["Aktivitas sekolah dan kerja terhenti", "Munculnya banyak jenis ikan baru", "Warga mendapat bantuan air bersih", "Sungai menjadi sarana wisata baru"],
                answer: "Aktivitas sekolah dan kerja terhenti",
                explanation: "Pembahasan: Sampah yang menyumbat sungai akan memicu banjir luapan. Banjir ini merendam akses jalan dan permukiman sehingga melumpuhkan aktivitas sosial harian warga."
            },
            {
                question: "Pembukaan lahan sawit baru sering dilakukan dengan cara membakar hutan secara luas. Hubungan langsung antara perbuatan tersebut dengan kondisi alam di permukaan Bumi adalah...",
                options: ["Meningkatnya suhu udara secara global", "Kesuburan tanah hutan makin terjaga", "Berkurangnya debit air sungai besar", "Munculnya spesies hewan jenis baru"],
                answer: "Meningkatnya suhu udara secara global",
                explanation: "Pembahasan: Pembakaran hutan melepaskan gas karbon dioksida dalam jumlah sangat besar ke atmosfer yang memperparah efek rumah kaca dan memicu pemanasan global."
            },
            {
                question: "Pencemaran udara akibat asap pabrik di sekitar kawasan industri semakin pekat. Dampak langsung terhadap kondisi kemasyarakatan di wilayah tersebut dalam jangka panjang adalah...",
                options: ["Meningkatnya pasien penyakit pernapasan warga", "Berkurangnya jumlah penduduk usia produktif", "Harga jual properti makin melambung", "Masyarakat mulai pindah kerja jauh"],
                answer: "Meningkatnya pasien penyakit pernapasan warga",
                explanation: "Pembahasan: Udara yang tercemar gas beracun dan partikel debu dari asap pabrik berbahaya bagi paru-paru, memicu tingginya angka penderita Infeksi Saluran Pernapasan Akut (ISPA)."
            },
            {
                question: "Penggunaan plastik sekali pakai saat berbelanja masih menjadi budaya masyarakat. Jika dibiarkan, permasalahan lingkungan yang mengancam kehidupan biota laut adalah...",
                options: ["Penyu mati akibat menelan plastik", "Ikan laut bertambah sangat banyak", "Terumbu karang tumbuh dengan cepat", "Kualitas air laut makin menjernih"],
                answer: "Penyu mati akibat menelan plastik",
                explanation: "Pembahasan: Sampah plastik yang terbawa ke laut sering dikira makanan (seperti ubur-ubur) oleh penyu. Jika tertelan, pencernaan tersumbat dan berujung pada kematian."
            },
            {
                question: "Penambangan pasir ilegal di pinggiran sungai terus dilakukan demi keuntungan ekonomi. Pola ini menyebabkan perubahan kondisi alam di wilayah sungai berupa...",
                options: ["Runtuhnya tebing di pinggir sungai", "Air sungai menjadi sangat jernih", "Aliran sungai semakin menjadi tenang", "Populasi ikan sungai makin banyak"],
                answer: "Runtuhnya tebing di pinggir sungai",
                explanation: "Pembahasan: Pengambilan pasir secara terus-menerus merusak struktur dasar dan tepi sungai, memicu erosi hebat yang berakibat pada longsornya tebing pinggiran sungai."
            },
            {
                question: "Kemarau panjang memicu kekeringan di berbagai daerah lumbung padi. Dampak ekonomi yang akan dirasakan langsung oleh masyarakat perkotaan akibat fenomena alam ini adalah...",
                options: ["Melambungnya harga bahan pangan pokok", "Menurunnya biaya pembayaran tagihan air", "Meningkatnya daya beli masyarakat kota", "Banyaknya warga desa pindah kota"],
                answer: "Melambungnya harga bahan pangan pokok",
                explanation: "Pembahasan: Kekeringan menyebabkan petani gagal panen. Berkurangnya pasokan hasil tani di pasar perkotaan akan menyebabkan harga bahan pangan melambung tinggi."
            },
            {
                question: "Sisa makanan yang terbuang menumpuk di tempat pembuangan akhir dan membusuk tanpa oksigen. Gas metana dari proses ini sangat berkontribusi terhadap...",
                options: ["Meningkatnya efek rumah kaca bumi", "Berkurangnya polusi udara kawasan kota", "Menyuburkan tanah di seluruh daerah", "Menurunkan suhu udara secara drastis"],
                answer: "Meningkatnya efek rumah kaca bumi",
                explanation: "Pembahasan: Gas metana yang dihasilkan dari sampah organik membusuk di TPA merupakan salah satu gas rumah kaca terkuat yang memerangkap panas di atmosfer Bumi."
            },
            {
                question: "Pembangunan villa dan hotel di daerah resapan air pegunungan semakin marak terjadi. Hubungan perbuatan ini dengan ketersediaan air tanah di dataran rendah adalah...",
                options: ["Mata air makin cepat mengering", "Cadangan air tanah bertambah banyak", "Kualitas air sumur makin menjernih", "Debit air sungai selalu stabil"],
                answer: "Mata air makin cepat mengering",
                explanation: "Pembahasan: Daerah resapan air yang tertutup beton/bangunan membuat air hujan tidak bisa meresap ke dalam tanah, sehingga pasokan air untuk sumur dan mata air terputus."
            },
            {
                question: "Intrusi (masuknya) air laut membuat sumur-sumur warga di area pesisir menjadi asin. Dampak permasalahan lingkungan ini terhadap kondisi sosial masyarakat adalah...",
                options: ["Sulitnya mendapat pasokan air minum", "Meningkatnya hasil produksi petani garam", "Warga pesisir makin rajin mandi", "Bertambahnya wisata pemandian air asin"],
                answer: "Sulitnya mendapat pasokan air minum",
                explanation: "Pembahasan: Sumur yang rasanya menjadi asin tidak lagi aman untuk dikonsumsi, sehingga warga mengalami krisis air tawar dan kesulitan memenuhi kebutuhan minum harian."
            },
            {
                question: "Pemakaian AC dan kulkas model lama yang melepaskan gas CFC secara berlebihan dapat merusak lingkungan. Dampak kerusakan ini bagi kondisi lapisan atmosfer bumi adalah...",
                options: ["Menipisnya lapisan ozon pelindung bumi", "Menurunnya suhu udara bumi drastis", "Mengurangi curah hujan secara global", "Menyebabkan gempa bumi lapisan tektonik"],
                answer: "Menipisnya lapisan ozon pelindung bumi",
                explanation: "Pembahasan: Gas CFC (Freon) yang terlepas ke udara akan naik ke stratosfer dan merusak molekul ozon, menyebabkan lapisan pelindung bumi dari sinar UV menjadi berlubang."
            },
            {
                question: "Penyedotan air tanah secara berlebihan oleh gedung bertingkat di kota besar memicu amblesnya permukaan tanah. Jika dibiarkan, prediksi dampak terburuk bagi kota pesisir adalah...",
                options: ["Tenggelamnya sebagian wilayah pesisir kota", "Tumbuhnya hutan beton secara cepat", "Meningkatnya kualitas sumber air tanah", "Bangunan kota menjadi lebih kokoh"],
                answer: "Tenggelamnya sebagian wilayah pesisir kota",
                explanation: "Pembahasan: Penurunan muka tanah (land subsidence) membuat daratan posisinya menjadi lebih rendah dibandingkan permukaan laut, berisiko tinggi menenggelamkan wilayah pesisir."
            },
            {
                question: "Sikap konsumtif sering membeli pakaian baru memicu penumpukan limbah kain (tekstil) yang sulit terurai. Gaya hidup tepat untuk mencegah hal tersebut adalah...",
                options: ["Menerapkan prinsip daur ulang pakaian", "Membakar semua pakaian yang bekas", "Menyimpan pakaian di dalam lemari", "Membeli pakaian buatan luar negeri"],
                answer: "Menerapkan prinsip daur ulang pakaian",
                explanation: "Pembahasan: Menggunakan kembali, mendonasikan, atau mendaur ulang pakaian lama (upcycling) sangat efektif menekan jumlah limbah industri tekstil di lingkungan."
            },
            {
                question: "Tumpahan minyak mentah dari kapal tanker mencemari lautan yang luas. Dampak ekonomi jangka pendek yang paling dirasakan oleh penduduk di sekitar perairan adalah...",
                options: ["Turunnya pendapatan dari sektor pariwisata", "Meningkatnya hasil panen rumput laut", "Harga ikan laut menjadi sangat murah", "Nelayan beralih menjadi pekerja pabrik"],
                answer: "Turunnya pendapatan dari sektor pariwisata",
                explanation: "Pembahasan: Pantai yang menjadi hitam dan bau akibat minyak akan langsung membuat wisatawan pergi. Hal ini mematikan usaha pariwisata yang berdampak pada ekonomi lokal."
            },
            {
                question: "Penebangan pohon bakau besar-besaran untuk perluasan tambak dapat merusak ekosistem. Perubahan kondisi alam yang sangat membahayakan pemukiman warga pesisir akibat hal ini adalah...",
                options: ["Hantaman gelombang laut makin kuat", "Angin laut berhembus makin pelan", "Kadar garam air laut menurun", "Pasir pantai menjadi makin putih"],
                answer: "Hantaman gelombang laut makin kuat",
                explanation: "Pembahasan: Hutan bakau (mangrove) berfungsi sebagai pemecah ombak alami. Tanpa bakau, energi gelombang pasang atau tsunami akan langsung menghantam dan menghancurkan pesisir."
            }
        ];

        // Unique key for LocalStorage
        const STORAGE_KEY = "scoreHistory_IPAS_K5_S2_B8";

        let currentUser = { nama: "", kelas: "" };
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = new Array(questions.length).fill(null);
        let hasAnsweredCurrent = false;

        // Initialize
        window.onload = () => {
            renderHistory();
        };

        function startQuiz() {
            const nama = document.getElementById('inputNama').value.trim();
            const kelas = document.getElementById('inputKelas').value.trim();

            if (!nama || !kelas) {
                alert("Harap isi Nama dan Kelas terlebih dahulu!");
                return;
            }

            currentUser = { nama, kelas };
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('quizScreen').style.display = 'block';
            
            // Reset quiz variables
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = new Array(questions.length).fill(null);
            updateScoreDisplay();
            loadQuestion();
        }

        // Shuffle Array
        function shuffleArray(array) {
            let shuffled = array.slice();
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function loadQuestion() {
            hasAnsweredCurrent = userAnswers[currentQuestionIndex] !== null;
            const q = questions[currentQuestionIndex];
            
            document.getElementById('questionCount').innerText = `Soal ${currentQuestionIndex + 1} / ${questions.length}`;
            document.getElementById('qText').innerText = q.question;

            // Handle Image
            const imgContainer = document.getElementById('imageContainer');
            if (q.image) {
                imgContainer.style.display = 'block';
                document.getElementById('qImage').src = q.image;
                document.getElementById('qCaption').innerText = q.caption;
            } else {
                imgContainer.style.display = 'none';
            }

            // Handle Options
            const optionsGrid = document.getElementById('optionsGrid');
            optionsGrid.innerHTML = '';
            
            // Generate or retrieve shuffled options
            let optionsToRender = [];
            if (!q.shuffledOptions) {
                q.shuffledOptions = shuffleArray(q.options);
            }
            optionsToRender = q.shuffledOptions;

            optionsToRender.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                
                // If already answered previously
                if (hasAnsweredCurrent) {
                    btn.disabled = true;
                    if (opt === q.answer) {
                        btn.classList.add('correct');
                    } else if (opt === userAnswers[currentQuestionIndex] && opt !== q.answer) {
                        btn.classList.add('wrong');
                    }
                } else {
                    btn.onclick = () => selectAnswer(btn, opt, q.answer);
                }
                
                optionsGrid.appendChild(btn);
            });

            // Handle Explanation
            const explBox = document.getElementById('explanationBox');
            if (hasAnsweredCurrent) {
                explBox.style.display = 'block';
                explBox.innerText = q.explanation;
            } else {
                explBox.style.display = 'none';
            }

            // Buttons
            document.getElementById('btnPrev').disabled = currentQuestionIndex === 0;
            document.getElementById('btnNext').disabled = !hasAnsweredCurrent;
            
            if (currentQuestionIndex === questions.length - 1 && hasAnsweredCurrent) {
                document.getElementById('btnNext').innerText = "Selesai & Simpan";
            } else {
                document.getElementById('btnNext').innerText = "Soal Selanjutnya";
            }
        }

        function selectAnswer(btnElement, selectedOpt, correctOpt) {
            if (hasAnsweredCurrent) return; // Prevent double click
            
            userAnswers[currentQuestionIndex] = selectedOpt;
            hasAnsweredCurrent = true;

            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => {
                b.disabled = true;
                if (b.innerText === correctOpt) {
                    b.classList.add('correct');
                }
            });

            if (selectedOpt === correctOpt) {
                score += (100 / questions.length);
            } else {
                btnElement.classList.add('wrong');
            }

            updateScoreDisplay();

            // Show explanation
            const explBox = document.getElementById('explanationBox');
            explBox.style.display = 'block';
            explBox.innerText = questions[currentQuestionIndex].explanation;

            document.getElementById('btnNext').disabled = false;
            if (currentQuestionIndex === questions.length - 1) {
                document.getElementById('btnNext').innerText = "Selesai & Simpan";
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                finishQuiz();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function updateScoreDisplay() {
            document.getElementById('scoreDisplay').innerText = `Skor Sementara: ${Math.round(score)}`;
        }

        function finishQuiz() {
            const finalScore = Math.round(score);
            alert(`Kuis Selesai! Skor Anda: ${finalScore}`);
            
            // Save to LocalStorage
            saveHistory(currentUser.nama, currentUser.kelas, finalScore);

            // Go back to login
            document.getElementById('quizScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            
            // Clear inputs & update table
            document.getElementById('inputNama').value = '';
            document.getElementById('inputKelas').value = '';
            renderHistory();
        }

        // History Management
        function saveHistory(nama, kelas, skor) {
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            const now = new Date();
            const timeString = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()} ${now.getHours()}:${now.getMinutes()}`;

            history.push({ nama, kelas, skor, waktu: timeString });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';

            if (history.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Belum ada riwayat pengerjaan</td></tr>`;
                return;
            }

            // Reverse to show latest first
            history.reverse().forEach(record => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.nama}</td>
                    <td>${record.kelas}</td>
                    <td><strong>${record.skor}</strong></td>
                    <td>${record.waktu}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>